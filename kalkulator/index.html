<script>
    // Inicjalizacja listy garnków
    const MOJE_GARNKI = [
        { nazwa: "Patelnia WOK", waga: 850 },
        { nazwa: "Garnek Duży (6L)", waga: 1200 },
        { nazwa: "Rondel mały", waga: 450 },
        { nazwa: "Naczynie żaroodporne", waga: 1100 }
    ];

    const select = document.getElementById('potSelect');
    MOJE_GARNKI.forEach((garnek) => {
        let opt = document.createElement('option');
        opt.value = garnek.waga;
        opt.innerHTML = `${garnek.nazwa} (${garnek.waga}g)`;
        select.appendChild(opt);
    });

    function togglePotSection() {
        const section = document.getElementById('potSection');
        const isChecked = document.getElementById('usePot').checked;
        section.style.display = isChecked ? 'block' : 'none';
        calculate();
    }

    function calculate() {
        let totalInput = parseFloat(document.getElementById('totalWeight').value) || 0;
        const portionInput = parseFloat(document.getElementById('portionWeight').value) || 0;
        const usePot = document.getElementById('usePot').checked;
        const potWeight = parseFloat(document.getElementById('potSelect').value) || 0;

        let wagaDaniaNetto = totalInput;

        if (usePot && totalInput > 0) {
            wagaDaniaNetto = totalInput - potWeight;
            document.getElementById('nettoDisplay').innerText = `Waga jedzenia netto: ${wagaDaniaNetto}g`;
        } else {
            document.getElementById('nettoDisplay').innerText = "";
        }

        if (wagaDaniaNetto > 0) {
            const val1 = Math.ceil(wagaDaniaNetto / 10);
            document.getElementById('res1').innerText = val1;
        } else {
            document.getElementById('res1').innerText = "-";
        }

        if (portionInput > 0) {
            const val2 = (portionInput / 10);
            document.getElementById('res2').innerText = val2;
        } else {
            document.getElementById('res2').innerText = "-";
        }
    }

    function saveToHistory() {
        const nameInput = document.getElementById('dishName');
        const totalInput = document.getElementById('totalWeight');
        const portionInput = document.getElementById('portionWeight');
        
        const name = nameInput.value || "Bez nazwy";
        const total = totalInput.value;
        const portion = portionInput.value;
        const res1 = document.getElementById('res1').innerText;
        const res2 = document.getElementById('res2').innerText;

        if (!total || !portion || res1 === "-" || res2 === "-") {
            alert("Najpierw wpisz poprawne dane!");
            return;
        }

        // POBIERANIE HISTORII Z ZABEZPIECZENIEM
        let history = [];
        try {
            const stored = localStorage.getItem('calcHistory');
            history = stored ? JSON.parse(stored) : [];
        } catch (e) {
            console.error("Błąd odczytu historii:", e);
            history = [];
        }

        const historyItem = {
            name: name,
            total: total,
            portion: portion,
            res1: res1,
            res2: res2,
            date: new Date().toLocaleString('pl-PL')
        };

        history.unshift(historyItem);
        
        // ZAPIS Z POWIERDZENIEM
        localStorage.setItem('calcHistory', JSON.stringify(history));
        
        // Czyścimy tylko pola wpisywania, nie historię!
        nameInput.value = "";
        totalInput.value = "";
        portionInput.value = "";
        calculate(); 
        
        renderHistory();
    }

    function renderHistory() {
        let history = [];
        try {
            history = JSON.parse(localStorage.getItem('calcHistory') || "[]");
        } catch (e) {
            history = [];
        }
        
        const list = document.getElementById('historyList');
        
        if (history.length === 0) {
            list.innerHTML = "<p style='color: #888; text-align: center;'>Brak wpisów</p>";
            return;
        }

        list.innerHTML = history.map(item => `
            <div class="history-item">
                <strong class="history-name">${item.name}</strong>
                <div class="history-details">
                    Całość: ${item.total}g → Porcji: <span class="history-results">${item.res1}</span><br>
                    Zjesz: ${item.portion}g → W Fitatu: <span class="history-results">${item.res2}</span>
                </div>
                <span class="history-date">${item.date}</span>
            </div>
        `).join('');
    }

    function clearHistory() {
        if(confirm("Czy na pewno chcesz WYMAZAĆ całą historię?")) {
            localStorage.removeItem('calcHistory');
            renderHistory();
        }
    }

    // Wywołaj przy starcie
    renderHistory();
</script>
