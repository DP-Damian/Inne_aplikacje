const API_URL = 'TUTAJ_WKLEJ_SWOJ_URL_Z_APPS_SCRIPT'; 
    let allItems = JSON.parse(localStorage.getItem('schowek_cache') || "[]");

    // Renderujemy to co mamy w pamici od razu przy starcie
    renderList(allItems);

    async function loadItems() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            // Mapowanie danych z Google
            allItems = data.map(row => ({ id: row[0], name: row[1], location: row[2] })).reverse();
            
            // Zapisujemy w pamici telefonu na za
            localStorage.setItem('schowek_cache', JSON.stringify(allItems));
            renderList(allItems);
            document.getElementById('statusMsg').innerText = "Zsynchronizowano.";
        } catch (error) {
            document.getElementById('statusMsg').innerText = "Tryb offline (brak synchro).";
        }
    }

    function renderList(items) {
        const list = document.getElementById('itemList');
        if (items.length === 0) {
            list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Brak przedmiot贸w w bazie.</p>";
            return;
        }
        list.innerHTML = items.map(i => `
            <div class="item-row" id="row-${i.id}">
                <span class="item-name">${i.name}</span>
                <span class="item-loc"> ${i.location}</span>
                <button class="btn btn-del" onclick="deleteItem('${i.id}')">USU</button>
            </div>
        `).join('');
    }

    function filterItems() {
        const term = document.getElementById('search').value.toLowerCase();
        const filtered = allItems.filter(i => 
            i.name.toString().toLowerCase().includes(term) || 
            i.location.toString().toLowerCase().includes(term)
        );
        renderList(filtered);
    }

    async function addItem() {
        const name = document.getElementById('itemName').value;
        const loc = document.getElementById('itemLoc').value;
        if (!name || !loc) return;

        const btn = document.getElementById('addBtn');
        btn.disabled = true;
        
        // --- OPTIMISTIC UI: Dodajemy na list od razu ---
        const tempId = Date.now().toString();
        const newItem = { id: tempId, name: name, location: loc };
        
        allItems.unshift(newItem);
        renderList(allItems);
        
        document.getElementById('itemName').value = "";
        document.getElementById('itemLoc').value = "";
        document.getElementById('statusMsg').innerText = "Zapisywanie w tle...";

        try {
            await fetch(API_URL, { 
                method: 'POST', 
                mode: 'no-cors', // Przyspiesza wysyk (nie czeka na pen odpowied藕)
                body: JSON.stringify({ item: name, location: loc }) 
            });
            btn.disabled = false;
            document.getElementById('statusMsg').innerText = "Zapisano!";
            // Odwie偶amy dane z serwera po 2 sekundach, 偶eby pobra prawdziwe ID z Google
            setTimeout(loadItems, 2000);
        } catch (e) {
            alert("Bd zapisu. Spr贸buj p贸藕niej.");
            btn.disabled = false;
        }
    }

    async function deleteItem(id) {
        if (!confirm("Usun ten wpis?")) return;
        
        // Ukrywamy od razu lokalnie
        allItems = allItems.filter(i => i.id != id);
        renderList(allItems);
        
        document.getElementById('statusMsg').innerText = "Usuwanie z serwera...";
        try {
            await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "delete", id: id }) 
            });
            document.getElementById('statusMsg').innerText = "Usunito.";
        } catch (e) {
            alert("Bd przy usuwaniu.");
            loadItems(); // Przywr贸 list jeli si nie udao
        }
    }

    loadItems();
